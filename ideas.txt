# Ä°yileÅŸtirme Fikirleri

================================================================================

## FÄ°KÄ°R: 15m vs 1h Momentum KarÄ±ÅŸÄ±klÄ±ÄŸÄ±

### Problem
AI zone_weakening_combined_rule kuralÄ±nÄ± uygularken 1h momentum ile 15m momentum'u karÄ±ÅŸtÄ±rdÄ±.

**Ã–rnek (Cycle 9 - DOGE):**
```
1h momentum: WEAKENING
15m momentum: STRENGTHENING

AI dedi: "UPPER_10 zone + 15m WEAKENING momentum"
GerÃ§ek: 15m momentum STRENGTHENING, 1h momentum WEAKENING
```

### OlasÄ± Ã‡Ã¶zÃ¼mler

1. **Prompt'u netleÅŸtir:** 
   - "CHECK 15m MOMENTUM ONLY (not 1h)"
   - Her koÅŸula explicit "15m" prefix ekle

2. **Veri sunumunu deÄŸiÅŸtir:**
   - Market data'da momentum field'larÄ±nÄ± "momentum_1h", "momentum_15m" olarak ayÄ±r
   - KarÄ±ÅŸÄ±klÄ±ÄŸÄ± Ã¶nle

3. **KuralÄ± basitleÅŸtir:**
   - Sadece zone + RSI threshold kullan
   - Momentum yerine RSI > 60 / RSI < 40 gibi sayÄ±sal deÄŸerler

### Durum
ğŸ“‹ BEKLEMEDE - Test edilecek

================================================================================

## FÄ°KÄ°R: Extreme RSI + Zone KuralÄ± (Counter-Trend FÄ±rsatÄ±)

### Problem
TRX LOWER_10 zone + RSI 19.4 (extreme oversold) durumunda AI "Consider LONG counter-trend" 
dedi ama counter_trade_analysis boÅŸ olduÄŸu iÃ§in aÃ§amadÄ±.

**Backtest Sonucu (Cycle 88-98):**
- GiriÅŸ: $0.2811, 10 cycle sonra: $0.281
- DeÄŸiÅŸim: -0.04% (break-even)
- RSI 19.4 â†’ 21.9 (hafif recovery baÅŸladÄ±)

### Ã–neri: Simetrik Extreme RSI KuralÄ±

**LONG iÃ§in:**
- Zone: LOWER_10 (percentile < 10)
- RSI (1h): < 25 (extreme oversold)
- VEYA WEAKENING momentum
â†’ Counter-trend LONG fÄ±rsatÄ± deÄŸerlendir

**SHORT iÃ§in:**
- Zone: UPPER_10 (percentile > 90)  
- RSI (1h): > 75 (extreme overbought)
- VEYA WEAKENING momentum
â†’ Counter-trend SHORT fÄ±rsatÄ± deÄŸerlendir

### Uygulama Yeri
1. `portfolio_manager.py` - confidence adjustment (runtime koruma)
2. `deepseek_api.py` - AI prompt'a kural ekle
3. `prompt_json_builders.py` - counter_trade_analysis'e extreme RSI koÅŸulu ekle

### Notlar
- 15m alignment GEREKMESÄ°N (RSI extreme zaten gÃ¼Ã§lÃ¼ sinyal)
- Volume > 0.50x gerektir (hard rule korunsun)
- Risk azaltma iÃ§in dÃ¼ÅŸÃ¼k confidence (0.40-0.55) kullan

### Durum
âœ… TAMAMLANDI - Zone+Weakening risk modifier eklendi (prompt_json_builders.py)

### Uygulanan DeÄŸiÅŸiklik
- Zone bonus koÅŸullarÄ± (15m timeframe):
  - LOWER_10 + WEAKENING (BEARISH trend) = LONG iÃ§in olumlu
  - UPPER_10 + WEAKENING (BULLISH trend) = SHORT iÃ§in olumlu
  - LOWER_10 + RSI < 30 (BEARISH trend) = LONG iÃ§in olumlu
  - UPPER_10 + RSI > 70 (BULLISH trend) = SHORT iÃ§in olumlu
- Risk seviyesi sadece 1 kademe dÃ¼ÅŸer (birden fazla koÅŸul saÄŸlansa bile):
  - VERY_HIGH_RISK â†’ HIGH_RISK
  - HIGH_RISK â†’ MEDIUM_RISK
  - MEDIUM_RISK ve LOW_RISK aynÄ± kalÄ±r

================================================================================

## Direction Rule KaldÄ±rÄ±ldÄ± (10 AralÄ±k 2025)

### Sorun
AI "direction_rule" kuralÄ±nÄ± yanlÄ±ÅŸ yorumluyordu:
```
"direction_rule": "Counter-trend direction = 15m+3m direction (NOT 1h direction)."
```

15m ve 3m zÄ±t yÃ¶nlerde olduÄŸunda (Ã¶rn: 15m=BEARISH, 3m=BULLISH), 
AI "15m+3m direction" hesaplayamÄ±yordu ve yanlÄ±ÅŸ yorumlar yapÄ±yordu.

### DeÄŸerlendirilen SeÃ§enekler

**SeÃ§enek A - direction_rule'u kaldÄ±r (UYGULAND):**
AI sadece risk_level'a odaklanÄ±r. YÃ¶n hesabÄ± kod tarafÄ±nda zaten yapÄ±lÄ±yor.

**SeÃ§enek B - direction_rule'u netleÅŸtir:**
```
"direction_rule": {
    "when_STRONG_alignment": "Direction = 15m AND 3m direction (both same)",
    "when_MEDIUM_alignment": "Direction = dominant timeframe (prefer 15m over 3m)",
    "when_NONE_alignment": "No counter-trend direction available"
}
```

**SeÃ§enek C - 15m'e Ã¶ncelik ver:**
```
"direction_rule": "Counter-trend direction = 15m direction. If 15m and 3m conflict, trust 15m."
```

### Neden SeÃ§enek A?
- En basit Ã§Ã¶zÃ¼m
- AI gereksiz yÃ¶n hesabÄ± yapmÄ±yor
- risk_level zaten tÃ¼m bilgiyi iÃ§eriyor (alignment + conditions â†’ risk)

================================================================================

## Portfolio-Level Profit Protection (10 AralÄ±k 2025) - Ã–NERÄ°

### Sorun TanÄ±mÄ±

Mevcut sistem pozisyon bazlÄ± erosion takibi yapÄ±yor, ancak portfÃ¶y seviyesinde koruma yok.

**Ã–rnek Senaryo:**
```
Pozisyon A: +$2.00 kÃ¢rda
Pozisyon B: +$1.50 kÃ¢rda  
Pozisyon C: -$0.50 zararda
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
TOPLAM:     +$3.00 kÃ¢rda (koruma yok!)

... zaman geÃ§er, market dÃ¶ner ...

Pozisyon A: -$1.00 zararda
Pozisyon B: -$1.00 zararda
Pozisyon C: -$1.00 zararda
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
TOPLAM:     -$3.00 zararda ğŸ˜”
```

**Problem:** +$3 toplam kÃ¢r elde edilmiÅŸti ama hiÃ§bir pozisyon bireysel olarak profit-taking tetiklemedi.
SonuÃ§: TÃ¼m kÃ¢r eridi ve zarara dÃ¶ndÃ¼.

### Ã‡Ã¶zÃ¼m Ã–nerileri

#### SeÃ§enek 1: Portfolio Profit Threshold (Basit)
```python
# Her cycle'da toplam unrealized PnL hesapla
total_unrealized_pnl = sum([pos.unrealized_pnl for pos in positions])

# EÅŸik deÄŸere ulaÅŸÄ±nca kar al
if total_unrealized_pnl >= PORTFOLIO_PROFIT_THRESHOLD:  # Ã¶rn: $3
    # En kÃ¢rlÄ± pozisyonu kapat
    most_profitable = max(positions, key=lambda p: p.unrealized_pnl)
    close_position(most_profitable)
```
**ArtÄ±:** Basit, kolay implement
**Eksi:** Potansiyel olarak erken kapama

#### SeÃ§enek 2: Portfolio Trailing Stop (AkÄ±llÄ±)
```python
# Peak portfolio profit'i takip et
if total_unrealized_pnl > peak_portfolio_profit:
    peak_portfolio_profit = total_unrealized_pnl
    lock_threshold = peak_portfolio_profit * 0.5  # %50'sini koru

# Peak'ten dÃ¼ÅŸÃ¼nce lock threshold altÄ±na inerse kapat
if peak_portfolio_profit > MINIMUM_PEAK:  # Ã¶rn: $2
    if total_unrealized_pnl < lock_threshold:
        close_all_losing_positions()  # veya close_all()
```
**ArtÄ±:** KÃ¢rÄ± korur, trend devam ederse Ã§alÄ±ÅŸmaz
**Eksi:** Daha karmaÅŸÄ±k, state yÃ¶netimi gerekli

#### SeÃ§enek 3: Portfolio Erosion Detection (AI Destekli)
```python
# AI prompt'a ekle:
portfolio_context = {
    "total_unrealized_pnl": total_unrealized_pnl,
    "peak_portfolio_profit": peak_portfolio_profit,
    "peak_reached_at_cycle": peak_cycle,
    "erosion_percentage": (peak - current) / peak * 100,
    "portfolio_erosion_warning": erosion_percentage > 50
}

# AI'Ä±n karar vermesini saÄŸla
"portfolio_erosion_rule": "If portfolio erosion >50% from peak, consider closing weakest positions"
```
**ArtÄ±:** AI context'e gÃ¶re akÄ±llÄ± karar verir
**Eksi:** AI hatalÄ± yorum yapabilir

#### SeÃ§enek 4: Time-Decay Profit Taking
```python
# KÃ¢r belirli sÃ¼re tutulursa al
if total_unrealized_pnl > 0:
    profit_duration_cycles += 1
else:
    profit_duration_cycles = 0

# N cycle boyunca kÃ¢rdaysa al
if profit_duration_cycles >= MAX_PROFIT_HOLD_CYCLES:  # Ã¶rn: 10 cycle
    if total_unrealized_pnl >= MINIMUM_TAKE_PROFIT:  # Ã¶rn: $1.50
        close_most_profitable_position()
```
**ArtÄ±:** "KÃ¢r almamak" problemini Ã§Ã¶zer
**Eksi:** Ä°yi trend'de erken kapatabilir

#### SeÃ§enek 5: Proportional Close (Hibrit)
```python
# Toplam kÃ¢r eÅŸiÄŸi aÅŸÄ±nca orantÄ±lÄ± kapat
if total_unrealized_pnl >= PORTFOLIO_PROFIT_THRESHOLD:
    for pos in positions:
        if pos.unrealized_pnl > 0:
            # KÃ¢rÄ±n %50'sini realize et (partial close)
            partial_close(pos, percentage=50)
```
**ArtÄ±:** Hem kÃ¢r alÄ±r hem trend'den Ã§Ä±kmaz
**Eksi:** Partial close karmaÅŸÄ±klÄ±ÄŸÄ±

### Ã–nerilen Implementasyon

**AÅŸama 1:** SeÃ§enek 1 (Portfolio Profit Threshold) ile baÅŸla - basit
**AÅŸama 2:** SeÃ§enek 2 (Trailing Stop) ekle - peak takibi
**AÅŸama 3:** SeÃ§enek 3 (AI Prompt) entegre et - akÄ±llÄ± karar

### Gerekli Config DeÄŸiÅŸkenleri
```python
PORTFOLIO_PROFIT_THRESHOLD: float = 3.0  # Kar al eÅŸiÄŸi ($)
PORTFOLIO_TRAILING_LOCK_PCT: float = 0.5  # Peak'in %50'sini koru
PORTFOLIO_MIN_PEAK_FOR_TRAILING: float = 2.0  # Trailing aktif olmasÄ± iÃ§in min peak
PORTFOLIO_EROSION_WARNING_PCT: float = 0.5  # %50 erosion = uyarÄ±
MAX_PROFIT_HOLD_CYCLES: int = 10  # N cycle kÃ¢rdaysa al
```

### Durum
â³ BEKLEMEDE - KullanÄ±cÄ± onayÄ± ve implementasyon seÃ§imi bekleniyor

================================================================================